<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout/defaultLayout">

<head>
    <title>AE모니터링</title>
</head>

<body id="page-top">

<th:block layout:fragment="content">

<!-- Begin Page Content -->
<div class="container-fluid">
    <!-- 참여자목록 -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 hig-pix">
            <h6 class="m-0 font-weight-bold text-primary">
                <div style="float: left">
                   <table style="font-size:12px">
                        <tr>
                            <td valign="middle" style="padding-right: 8px;font-size: 1rem";>
                                참여자 정보
                            </td>
                            <td valign="middle" style="padding: 8px;color:#4e73df;border: 1px solid #d1d3e2;background-color: #e3f2fd";>
                                ENP_NO
                            </td>
                            <td valign="middle" style="padding: 8px;color:#858796;border: 1px solid #d1d3e2";>
                                [[${prtcpntInfo.enrlNo}]]
                            </td>
                            <td valign="middle" style="padding: 8px;color:#4e73df;border: 1px solid #d1d3e2;background-color: #e3f2fd">
                                성명
                            </td>
                            <td valign="middle" style="padding: 8px;color:#858796;border: 1px solid #d1d3e2">
                                [[${prtcpntInfo.initial}]]
                            </td>
                            <td valign="middle" style="padding: 8px;color:#4e73df;border: 1px solid #d1d3e2;background-color: #e3f2fd">
                                성별
                            </td>
                            <td valign="middle" style="padding: 8px;color:#858796;border: 1px solid #d1d3e2">
                                [[${prtcpntInfo.sexdstnCode}]]
                            </td>
                            <td valign="middle" style="padding: 8px;color:#4e73df;border: 1px solid #d1d3e2;background-color: #e3f2fd">
                                생년월일
                            </td>
                            <td valign="middle" style="padding: 8px;color:#858796;border: 1px solid #d1d3e2">
                                [[${prtcpntInfo.birthday}]]
                            </td>
                            <td valign="middle" style="padding: 8px;color:#4e73df;border: 1px solid #d1d3e2;background-color: #e3f2fd">
                                증상
                            </td>
                            <td valign="middle" style="padding: 8px;color:#858796;border: 1px solid #d1d3e2">
                                [[${prtcpntInfo.newSymptms}]]
                            </td>
                            <td valign="middle" style="padding: 8px;color:#4e73df;border: 1px solid #d1d3e2;background-color: #e3f2fd">
                                연락처
                            </td>
                            <td valign="middle" style="padding: 8px;color:#858796;border: 1px solid #d1d3e2">
                                [[${prtcpntInfo.telno}]]
                                <input type="hidden" id="s_mobileNumber" name="s_mobileNumber" th:value="${prtcpntInfo.telno}" />
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="layout940 hig-bt-pix" style="float: right">
                    <a href='javascript:apiSubjectRead(pcn_server,
                                                        $("#s_studyId").val(),
                                                        $("#s_prtcpntId").val());'
                       class="btn btn-primary btn-icon-split btn-sm">
                        <span class="icon text-white-50">
                            <i class="fas fa-search fa-sm"></i>
                        </span><span class="text">대상조회</span>
                    </a>

                    <a href='javascript:apiMappingConnect(pcn_server,
                                                        $("#s_studyId").val(),
                                                        $("#s_prtcpntId").val(),
                                                        $("#s_mobileNumber").val());'
                       class="btn btn-primary btn-icon-split btn-sm">
                        <span class="icon text-white-50">
                            <i class="fas fa-search fa-sm"></i>
                        </span><span class="text">설정변경</span>
                    </a>

                    <a href='javascript:apiMappingDisconnect(pcn_server,
                                                        $("#s_studyId").val(),
                                                        $("#s_prtcpntId").val());'
                       class="btn btn-primary btn-icon-split btn-sm">
                        <span class="icon text-white-50">
                            <i class="fas fa-search fa-sm"></i>
                        </span><span class="text">설정해제</span>
                    </a>

                    <a href='javascript:apiSubjectCreate(pcn_server,
                                                        $("#s_studyId").val(),
                                                        $("#s_prtcpntId").val(),
                                                        $("#s_mobileNumber").val(),
                                                        gOngoing);'
                       class="btn btn-primary btn-icon-split btn-sm">
                        <span class="icon text-white-50">
                            <i class="fas fa-search fa-sm"></i>
                        </span><span class="text">대상등록</span>
                    </a>

                    <a href="javascript:examlistGo();" class="btn btn-primary btn-icon-split btn-sm">
                        <span class="icon text-white-50">
                            <i class="fas fa-arrow-right"></i>
                        </span>
                        <span class="text">검색</span>
                    </a>
                </div>
            </h6>
        </div>
    </div>
    <!-- End of 참여자목록  -->

    <!-- 증상 -->
    <div id="SymptmsUi" style="position: relative">

        <!-- 참여자 증상 Start -->
        <div class="leftLayout">
            <div class="card shadow mb-4" id="SymptmsUiLeft" style="margin-right:4px;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <div style="float: left">
                            <table style="font-size:12px">
                                <tr>
                                    <td valign="middle" style="padding: 8px 8px 8px 0px;font-size: 1rem";>
                                        증상정보
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <div style="float: right">
                            <table style="font-size:12px">
                                <tr>
                                    <td valign="middle" style="padding: 4px;">
                                        <input type="checkbox" id="selSymptmsSeq100" name="selSymptmsSeq" index="0" style="width: 20px;height: 20px"
                                               onchange="symptmsListDataChangeSelect();" checked>
                                    </td>
                                    <td valign="middle" style="padding: 4px;color:#858796">
                                        앱
                                    </td>
                                    <td valign="middle" style="padding: 4px;">
                                        <input type="checkbox" id="selSymptmsSeq300" name="selSymptmsSeq" index="0" value="Y" style="width: 20px;height: 20px"
                                               onchange="symptmsListDataChangeSelect();" checked>
                                    </td>
                                    <td valign="middle" style="padding: 4px;color:#858796">
                                        전화
                                    </td>
                                    <td valign="middle" style="padding: 4px;">
                                        <input type="checkbox" id="selSymptmsSeq400" name="selSymptmsSeq" index="0" value="Y" style="width: 20px;height: 20px"
                                               onchange="symptmsListDataChangeSelect();" checked>
                                    </td>
                                    <td valign="middle" style="padding: 4px;color:#858796">
                                        대면
                                    </td>
                                    <td valign="middle" style="padding-left: 4px;">
                                        <a href="javascript:SymptomDetailNew();" class="btn btn-primary btn-icon-split btn-sm">
                                            <span class="icon text-white-50">
                                                <i class="fas fa-arrow-right"></i>
                                            </span>
                                            <span class="text">입력</span>
                                        </a>
                                    </td>
                                </tr>
                            </table>
                        </div>

                    </h6>
                </div>
                <div class="card-body" style="position:relative">
                    <div id="symptomChart" class="table-responsive">
                        <div id="symptomChartLeft" style="overflow-x:hidden;">
                            <table class="table table-bordered" id="SymptomTable" width="100%" cellspacing="0"  style="font-size:12px;">
                                <thead>
                                <tr>
                                    <th width="16%">NO</th>
                                    <th width="0%">studyId</th>
                                    <th width="0%">prtcpntId</th>
                                    <th width="0%">symptmsSeq</th>
                                    <th width="0%">symptmsRegtypeCode</th>
                                    <th width="16%">구분</th>
                                    <th width="18%">등록일</th>
                                    <th width="20%">확인여부</th>
                                    <th width="30%">내용</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="SymptomDetail" class="card-body">dfsdfs</div>
            </div>
        </div>
        <!-- 참여자 증상 End -->
        <!-- AE 모니터링 Start -->
        <div class="rightLayout" >
            <div class="card shadow mb-4" id="SymptmsUiRight" style="margin-left:4px;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <div style="float: left">
                            <table style="font-size:12px">
                                <tr>
                                    <td valign="middle" style="padding: 8px 8px 8px 0px;font-size: 1rem";>
                                        AE모니터링
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div style="float: right">
                            <a href="javascript:aeChartViewNew();" class="btn btn-primary btn-icon-split btn-sm">
                                <span class="icon text-white-50">
                                    <i class="fas fa-arrow-right"></i>
                                </span>
                                <span class="text">입력</span>
                            </a>
                        </div>
                    </h6>
                </div>
                <div class="card-body" style="position:relative">
                    <div id="aeTree"></div>
                </div>
                <div id="aeChart" class="card-body aeChartUI"></div>
            </div>
        </div>
        <!-- AE 모니터링 End -->
    </div>
    <!-- End of 증상 -->
</div>
<!-- /.container-fluid -->

<div id="adMoniModal" class="adMoniModal">
    <div id="pcnctcae" class="card-body aeChartUI adMoniModalCont"></div>
</div>

<form id="Prtcpnt" name="Prtcpnt" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" id="s_studyId" name="s_studyId"  th:value="${s_studyId}" />
    <input type="hidden" id="s_studyInstId" name="s_studyInstId" th:value="${s_studyInstId}" />
    <input type="hidden" id="s_prtcpntId" name="s_prtcpntId" th:value="${s_prtcpntId}" />
</form>

 <style type="text/css">
    .table td, .table th {
        padding: .55rem;
    }
    .selected {
        background: lightgoldenrodyellow !important;
    }
    .table-bordered > tbody > tr:not(.selected):hover {
        cursor: pointer !important;
        background: lightgray !important;
    }
    .tableClass {
        width : 100%;
        font-size : 12px;
    }
    .tableClass td, .tableClass th {
        padding: .55rem;
    }
    .tdTextRight {
        text-align:right;
        border-top: 1px solid lightgray;
        border-bottom: 1px solid lightgray;
    }
    .tdTextLeft {
        text-align:left;
        border-top: 1px solid lightgray;
        border-bottom: 1px solid lightgray;
    }
    .tdTextCenter {
        text-align:center;
        border-top: 1px solid lightgray;
        border-bottom: 1px solid lightgray;
    }
    .btn_right {
        border-radius: 5px;
        border: 1px solid skyblue;
        background-color: #4e73df;
        color: #ffffff;
        padding: 6px;
        display:inline;
    }
    .dis_inline {
        display:inline;
    }
    .aeChartUI {
        border:1px solid darkgray;
        background-color: #ffffff;
        width:100%;
        border-radius: calc(.35rem - 1px);"
    }
    .adMoniModal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 999; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
    }

    .adMoniModalCont {
        margin: auto;
        padding: 20px;
        width:70%;
        z-index: 999;
        background-color: #ffffff;
    }
</style>

<script th:src="@{/js/ae-api-v-1.js}" ></script>
<script>
    var gStudyId;
    var gPrtcpntId;
    var gStudyInstId;
    var gSymptmsSeq;
    var gSumrySeq;
    var gOngoing = "Ongoing";

    $(document).ready(function() {
        var events = $('#events');
        $('#SymptmsUi').hide();
        $('#aeChart').hide();
        $("#adMoniModal").hide();

        $('#SymptomTable').DataTable( {
            scrollY:        "176px",
            scrollCollapse: true,
            paging:         true,
            columnDefs: [
                {
                    "targets": [1],
                    "visible": false,
                    "searchable": false
                },
                {
                    "targets": [2],
                    "visible": false
                },
                {
                    "targets": [3],
                    "visible": false
                },
                {
                    "targets": [4],
                    "visible": false
                }
            ],
            responsive: true,
            bInfo : false
        } );

        PrtcpntView();
    } );

    function examlistGo() {
        var form = document.Prtcpnt;
        form.action = "[[@{/aemonitor/examlist}]]";
        form.submit();
    }

    function aeChartClose() {
        console.log("aeChartClose -->");
        $('#symptomChart').show();
        $("#aeChart").empty();
        $('#aeChart').hide();
    }

    function PrtcpntView() {
        gStudyId = $("#s_studyId").val();
        gPrtcpntId = $("#s_prtcpntId").val();
        //$("#studyId").val(gStudyId);
        //$("#studyInstId").val(gPrtcpntId);

        symptmsListDataChange(gStudyId, gPrtcpntId, 1);
        aeTreeDataChange(gStudyId, gPrtcpntId, 'All');

        $("#aeChart").empty();
        $('#aeChart').hide();
        $('#symptomChart').show();
        $('#SymptmsUi').show();
        $("#dataTable tr").not(this).removeClass('selected');
        $(this).addClass('selected');
        //$(this).toggleClass('selected');
    };

    $('#SymptomTable tbody').on('click', 'tr', function () {
        var data = $('#SymptomTable').DataTable().row( this ).data();
        SymptomDetail(data[1], data[2], data[3]);
        $("#SymptomTable tr").not(this).removeClass('selected');
        $(this).addClass('selected');
        //$(this).toggleClass('selected');
    });

    function  aeChartViewNew() {
        console.log("aeChartViewNew-studyId : " + gStudyId);
        console.log("aeChartViewNew-prtcpntId : " + gPrtcpntId);

        $.ajax({
            url:'[[@{/aemonitor/aeChartViewNew}]]',
            type:'get',
            dataType: 'html',
            data:{
                studyId : gStudyId,
                prtcpntId : gPrtcpntId,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){
                $(".aeTree").css("color", "#858796");
                $(".aeTree").css("font-weight", "normal");

                //$('#symptomChart').hide();
                $("#aeChart").empty();
                $('#aeChart').show();
                $("#aeChart").html(data);
            }
        });
    }

    function  aeChartView(studyId, prtcpntId, sumrySeq, mntrngSeq) {
        console.log("aeChartView-studyId : " + studyId);
        console.log("aeChartView-prtcpntId : " + prtcpntId);
        console.log("aeChartView-sumrySeq : " + sumrySeq);
        gSumrySeq = sumrySeq;

        $.ajax({
            url:'[[@{/aemonitor/aeChartView}]]',
            type:'get',
            dataType: 'html',
            data:{
                studyId : studyId,
                prtcpntId : prtcpntId,
                sumrySeq : sumrySeq,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){
                //$('#symptomChart').hide();
                $("#aeChart").empty();
                $('#aeChart').show();
                $("#aeChart").html(data);
            }
        });
    }

    function aeChartInsert() {
        if ($("#aeTermCtcae").val() == "") {
            modal({
                type: 'warning',
                title: '주의',
                text: 'AE명을 입력해 주십시오',
                center: false,
            });
            $("#aeTermCtcae").focus();
            return;
        }
        var param = $("form[name=AEMMntrngVOForm]").serialize();
        $.ajax({
            url:'[[@{/aemonitorapi/aeChartInsert}]]',
            type:'post',
            data: param,
            success:function(data){
                console.log(data);
                modal({
                    type: 'success',
                    title: 'Success',
                    text: '등록되었습니다.'
                });
                aeTreeDataChange(gStudyId, gPrtcpntId, 'All');
                aeChartView(gStudyId, gPrtcpntId, 0, '');

                if ( $("#actionDcsnAt").is(":checked") == true ) {
                    gOngoing = "Ongoing";
                }
                else {
                    gOngoing = "None";
                }
                apiSubjectUpdate(pcn_server, gStudyId, gPrtcpntId, gOngoing);
            },
            error:function(data){
                console.log(data);
            }
        });
    }

    function aeFavorites() {
        if ($("#aeTermCtcae").val() == "") {
            modal({
                type: 'warning',
                title: '주의',
                text: 'AE명을 입력해 주십시오',
                center: false,
            });
            $("#aeTermCtcae").focus();
            return;
        }
        var param = $("form[name=AEMMntrngVOForm]").serialize();
        $.ajax({
            url:'[[@{/aemonitorapi/aeFavorite}]]',
            type:'post',
            data: param,
            success:function(data){
                console.log(data);
                modal({
                    type: 'success',
                    title: 'Success',
                    text: '즐겨 찾기에 등록되었습니다.'
                });
            },
            error:function(data){
                console.log(data);
            }
        });
    }

    function aeChartUpdate(code) {
        var messageVal = "수정되었습니다.";
        if ( code == 1) {
            $("#mntrngDcsnAt").val("Y");
        }
        else {
            $("#mntrngDcsnAt").val("N");
        }

        if ( code == 2 ) {
            messageVal = "삭제되었습니다.";
        }
        var param = $("form[name=AEMMntrngVOForm]").serialize();
        $.ajax({
            url:'[[@{/aemonitorapi/aeChartUpdate}]]',
            type:'post',
            data: param,
            success:function(data){
                console.log(data);
                modal({
                    type: 'success',
                    title: 'Success',
                    text: messageVal
                });
                aeTreeDataChange(gStudyId, gPrtcpntId, 'All');
                if ( code != 2 ) {
                    aeChartView(gStudyId, gPrtcpntId, gSumrySeq, '');
                }
                else {
                    $("#aeChart").empty();
                    $("#aeChart").hide();
                }

                if ( $("#actionDcsnAt").is(":checked") == true ) {
                    gOngoing = "Ongoing";
                }
                else {
                    gOngoing = "None";
                }
                apiSubjectUpdate(pcn_server, gStudyId, gPrtcpntId, gOngoing);
            },
            error:function(data){
                console.log(data);
            }
        });
    }
    function aeChartDelete() {
        modal({
            type: 'confirm',
            title: '주의',
            text: '삭제 하시겠습니까?',
            callback: function (result) {
                if ( result == true) {
                    $("#useYn").val("N");
                    aeChartUpdate(2);
                }
            }
        })
    }

    function aeChartAction() {
        aeChartUpdate(1);
    }

    function SymptmsInsert() {
        if ($("#symptmsCn").val() == "") {
            modal({
                type: 'warning',
                title: '주의',
                text: '내용을 입력해 주십시오.',
                center: false,
            });
            $("#symptmsCn").focus();
            return;
        }

        var param = $("form[name=aemPrtcpntSymptmsVOForm]").serialize();
        $.ajax({
            url:'[[@{/aemonitorapi/symptmsInsert}]]',
            type:'post',
            data: param,
            success:function(data){
                console.log(data);
                modal({
                    type: 'success',
                    title: 'Success',
                    text: '등록되었습니다.'
                });
                aemStdyPrtcpntDataChange(4);
                $('#symptomChart').show();
                $('#SymptmsUi').show();
            },
            error:function(data){
                console.log(data);
            }
        });
    }

    function SymptmsUpdate() {
        if ($("#symptmsCn").val() == "") {
            modal({
                type: 'warning',
                title: '주의',
                text: '내용을 입력해 주십시오.',
                center: false,
            });
            $("#symptmsCn").focus();
            return;
        }

        var param = $("form[name=aemPrtcpntSymptmsVOForm]").serialize();
        $.ajax({
            url:'[[@{/aemonitorapi/symptmsUpdate}]]',
            type:'post',
            data: param,
            success:function(data){
                console.log(data);
                modal({
                    type: 'success',
                    title: 'Success',
                    text: '수정되었습니다.'
                });
                aemStdyPrtcpntDataChange(2);
                $('#symptomChart').show();
                $('#SymptmsUi').show();

                //확인 상태일때만 전송?
                if ( $("#symptmsConfirm").is(":checked") == true ) {
                    apiMessageReadCheck(pcn_server, $("#symptmsSeq").val());
                }
            },
            error:function(data){
                console.log(data);
            }
        });
    }

    function SymptmsDelete() {
        var param = $("form[name=aemPrtcpntSymptmsVOForm]").serialize();
        modal({
            type: 'confirm',
            title: '주의',
            text: '삭제 하시겠습니까?',
            callback: function(result) {
                if ( result == true) {
                    $.ajax({
                        url:'[[@{/aemonitorapi/symptmsDelete}]]',
                        type:'post',
                        data: param,
                        success:function(data){
                            console.log(data);
                            modal({
                                type: 'success',
                                title: 'Success',
                                text: '삭제되었습니다.'
                            });
                            aemStdyPrtcpntDataChange(3);
                            $('#symptomChart').show();
                            $('#SymptmsUi').show();
                        },
                        error:function(data){
                            console.log(data);
                        }
                    });
                }
            }
        });
    }

    function  SymptomDetailNew() {
        console.log("SymptomDetailNew-studyId : " + gStudyId);
        console.log("SymptomDetailNew-prtcpntId : " + gPrtcpntId);

        $.ajax({
            url:'[[@{/aemonitor/symptmsNew}]]',
            type:'get',
            dataType: 'html',
            data:{
                studyId : gStudyId,
                prtcpntId : gPrtcpntId,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){
                $("#SymptomDetail").empty();
                $("#SymptomDetail").html(data);
            }
        });
    }

    function  SymptomDetail(studyId, prtcpntId, symptmsSeq) {
        var counter = 1;
        console.log("SymptomDetail-studyId : " + studyId);
        console.log("SymptomDetail-prtcpntId : " + prtcpntId);
        console.log("SymptomDetail-symptmsSeq : " + symptmsSeq);

        gSymptmsSeq = symptmsSeq;

        $.ajax({
            url:'[[@{/aemonitor/symptms}]]',
            type:'get',
            dataType: 'html',
            data:{
                studyId : studyId,
                prtcpntId : prtcpntId,
                symptmsSeq : symptmsSeq,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){
                $("#SymptomDetail").empty();
                $("#SymptomDetail").html(data);
            }
        });
    }

    function  aeTreeDataChange(studyId, prtcpntId, viewType) {
        var counter = 1;
        console.log("aeTreeDataChange-studyId : " + studyId);
        console.log("aeTreeDataChange-prtcpntId : " + prtcpntId);

        $.ajax({
            url:'[[@{/aemonitorapi/aeTreeList}]]',
            type:'get',
            dataType: 'json',
            data:{
                studyId : studyId,
                prtcpntId : prtcpntId,
                viewType : viewType,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){
                $("#aeTree").empty();
                $.each(data, function(key) {
                    $('#aeTree').append('<div style="padding-top:2px;padding-bottom:2px;">'
                        + '<!--<img src="/img/graychip.png" style="margin-right:4px;width:8px;height:8px;">-->'
                        + '● <span class="aeTree" id="aeTreeRow_' + key + '" style="cursor:pointer;" onclick="aeChartView(\''
                        + data[key].studyId + '\',\''
                        + data[key].prtcpntId + '\',\''
                        + data[key].sumrySeq + '\',\''
                        + '' + '\'); aeTreeSet($(this));">'
                        + '[AE명 : ' + data[key].adNm + '], '
                        + '[Grade : ' + data[key].grade + '], '
                        + '[AE시작일 : ' + data[key].startDt + '], '
                        + '[AE종료일 : ' + data[key].endDt + '], '
                        + '[Serious여부 : ' + data[key].serious + '], '
                        + '[Serious내용 : ' + data[key].seriousCont + '], '
                        + '[인과관계 : ' + data[key].relation + '], '
                        + '[예측여부 : ' + data[key].prediction + '], '
                        + '[관련조치 : ' + data[key].relationMeasure + '], '
                        + '[기타조치 : ' + data[key].etcMeasure + '], '
                        + '[결과 : ' + data[key].aeResult + '], '
                        + '[' + data[key].mnAt + ']'
                        + '</span>'
                        + '<img src="/img/copy.png" style="margin-left:4px;width:12px;height:12px;" onclick="copyElement(\'aeTreeRow_' + key + '\')"></div>');

                    //가장 최근 상태를 공유함
                    if ( count == 1 && data[key].endDt == "ongoing") {
                        gOngoing = "Ongoing";
                    }
                    else {
                        gOngoing = "None";
                    }
                    counter++;
                });
            }
        });
    }

    function aeTreeSet(item) {
        $(".aeTree").css("color", "#858796");
        $(".aeTree").css("font-weight", "normal");
        item.css("color", "#1e73be");
        item.css("font-weight", "700");
    }

    function  symptmsListDataChange(studyId, prtcpntId, gubun) {
        var tableGrid = $('#SymptomTable').DataTable();
        var counter = 1;
        var viewType = "900";

        if ( $("#selSymptmsSeq100").is(":checked") == true ) viewType = viewType + ",110,120,130,140";
        if ( $("#selSymptmsSeq300").is(":checked") == true ) viewType = viewType + ",300";
        if ( $("#selSymptmsSeq400").is(":checked") == true ) viewType = viewType + ",400";

        console.log("symptmsListDataChange-studyId : " + studyId);
        console.log("symptmsListDataChange-prtcpntId : " + prtcpntId);
        console.log("symptmsListDataChange-viewType : " + viewType);
        gStudyId = studyId;
        gPrtcpntId = prtcpntId;

        $.ajax({
            url:'[[@{/aemonitorapi/symptmsList}]]',
            type:'get',
            dataType: 'json',
            data:{
                studyId : studyId,
                prtcpntId : prtcpntId,
                viewType : viewType,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){
                $("#SymptomDetail").empty();
                tableGrid.clear().draw();

                $.each(data, function(key) {
                    if ( gubun == 4 && key == 0 ) {
                        gSymptmsSeq =  data[key].symptmsSeq;
                    }
                    tableGrid.row.add([
                        counter,
                        data[key].studyId,
                        data[key].prtcpntId,
                        data[key].symptmsSeq,
                        data[key].symptmsRegtypeCode,
                        data[key].symRegTxt,
                        data[key].symptmsRegistDe,
                        data[key].symptmsConfirm,
                        data[key].symptmsCn
                    ]).draw(false);
                    counter++;
                });
                $("#adMoniModal").hide();
                if (gubun == 2 || gubun == 4) {
                    SymptomDetail(gStudyId, gPrtcpntId, gSymptmsSeq);
                }
            }
        });
    }

    function symptmsListDataChangeSelect() {
        symptmsListDataChange(gStudyId, gPrtcpntId, 1);
    }

    function aemStdyPrtcpntDataChange(gubun) {
        var tableGrid = $('#dataTable').DataTable();
        var symptomTable = $('#SymptomTable').DataTable();
        var counter = 1;

        var studyId = $("#studyId").val();
        var studyInstId = $("#studyInstId").val();
        var setStartDe  = $("#sdate").val();
        var setEndDe = $("#edate").val();
        var setAllAt = "N";
        var setTodayAt = "N";
        if ( $("#setAllAt").is(":checked") == true ) setAllAt = "Y";
        if ( $("#setTodayAt").is(":checked") == true ) setTodayAt = "Y";
        if (setStartDe = "") setStartDe = "00000000";
        if (setEndDe = "") setEndDe = "99999999";

        console.log("studyId : " + studyId);
        console.log("studyInstId : " + studyInstId);
        gStudyId = studyId;
        gStudyInstId = studyInstId;

        $.ajax({
            url:'[[@{/aemonitorapi/aemStdyPrtcpnt}]]',
            type:'get',
            dataType: 'json',
            data:{
                studyId : studyId,
                studyInstId : studyInstId,
                setAllAt : setAllAt,
                setTodayAt : setTodayAt,
                setStartDe : setStartDe,
                setEndDe : setEndDe,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){

                if ( gubun == 1 ) {
                    $("#aeChart").empty();
                    $('#aeChart').hide();
                    $('#SymptmsUi').hide();
                    $("#SymptomDetail").empty();
                }
                tableGrid.clear().draw();
                symptomTable.clear().draw();
                $.each(data, function(key) {
                    //console.log("list data : " + data[key].initial);
                    tableGrid.row.add([
                        counter,
                        data[key].studyId,
                        data[key].prtcpntId,
                        data[key].enrlNo,
                        data[key].initial,
                        data[key].newSymptms,
                        data[key].sexdstnCode,
                        data[key].telno,
                        data[key].birthday,
                        data[key].pcnAppId,
                        data[key].visitForecastDe,
                        data[key].regDt,
                        data[key].cnfrmrNm,
                    ]).draw(false);

                    counter++;
                });
                $("#adMoniModal").hide();
                if (gubun != 1) {
                    symptmsListDataChange(gStudyId, gPrtcpntId, gubun);
                }
            }
        });
    }

    function pcnctcaeView() {
        gCtcaeVer = "";
        gMedDraCode = "";
        gMedDraSoc = "";
        gTerm = "";
        gGrade = "";
        gGrade_Lv = "";

        $.ajax({
            url:'[[@{/aemonitor/pcnctcaeView}]]',
            type:'get',
            dataType: 'html',
            data:{
                studyId : gStudyId,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){
                $("#pcnctcae").empty();
                $("#pcnctcae").html(data);
                $("#adMoniModal").show();
            }
        });
    }

    function pcnctcaeHide() {
        $("#pcnctcae").empty();
        $("#adMoniModal").hide();
    }

    function gradeChoiceSend(term, medDraCode, grade_Lv) {
        $('#aeTermCtcae').val(term);
        $('#medDraCode').val(medDraCode);
        $('#aeGrade' + grade_Lv).prop('checked',true);
        pcnctcaeHide();
    }

    function allRowChoiceSend(medDraCode
        ,aeTremNm
        ,aeGrade
        ,saeAt
        ,saeDeath
        ,saeLifeThrt
        ,saeHsptlzNeed
        ,saeCsmalfnc
        ,saeCsdeform
        ,saeEtcSittn
        ,causalityCode
        ,predictAt
        ,aeActionCode
        ,etcActionCode
        ,aeRsltCode) {

        $('#aeTermCtcae').val(aeTremNm);
        $('#medDraCode').val(medDraCode);

        if (aeGrade != "") $('#aeGrade' + (aeGrade / 10)).prop('checked', true);
        if (saeAt == 'Y') $('#saeAt1').prop('checked', true);
        if (saeAt == 'N') $('#saeAt2').prop('checked', true);

        if (saeDeath == 'Y') $('#saeDeath').prop('checked', true);
        if (saeLifeThrt == 'Y') $('#saeLifeThrt').prop('checked', true);
        if (saeHsptlzNeed == 'Y') $('#saeHsptlzNeed').prop('checked', true);
        if (saeCsmalfnc == 'Y') $('#saeCsmalfnc').prop('checked', true);
        if (saeCsdeform == 'Y') $('#saeCsdeform').prop('checked', true);
        if (saeEtcSittn == 'Y') $('#saeEtcSittn').prop('checked', true);

        if (causalityCode == 'A10') $('#causalityCode1').prop('checked', true);
        if (causalityCode == 'B10') $('#causalityCode2').prop('checked', true);
        if (causalityCode == 'A20') $('#causalityCode3').prop('checked', true);
        if (causalityCode == 'B20') $('#causalityCode4').prop('checked', true);
        if (causalityCode == 'B30') $('#causalityCode5').prop('checked', true);
        if (causalityCode == 'B40') $('#causalityCode6').prop('checked', true);
        if (causalityCode == 'B50') $('#causalityCode7').prop('checked', true);
        if (causalityCode == 'B60') $('#causalityCode8').prop('checked', true);
        if (causalityCode == 'B70') $('#causalityCode9').prop('checked', true);

        if (predictAt == 'Y') $('#predictAt1').prop('checked', true);
        if (predictAt == 'N') $('#predictAt2').prop('checked', true);

        if (aeActionCode != "") $('#aeActionCode' + (aeActionCode / 10)).prop('checked', true);
        if (etcActionCode != "") $('#etcActionCode' + (etcActionCode / 10)).prop('checked', true);
        if (aeRsltCode != "") $('#aeRsltCode' + (aeRsltCode / 100)).prop('checked', true);
        pcnctcaeHide();
    }

    function  PcnctcaeListDataChange() {
        var tableGrid = $('#pcnctcaeList').DataTable();
        var pcnctcaeVal = "";
        var ctcaeVer = "";
        var medDraSoc = "";
        var searchVal = $("#pcnctinput").val();

        if ( $("#pcnctcaeCoList").val() != "" ) {
            pcnctcaeVal = $("#pcnctcaeCoList").val().split("|");
            ctcaeVer = pcnctcaeVal[0];
            medDraSoc = pcnctcaeVal[1];
        }

        if ( ctcaeVer == "" && searchVal == "" ) {
            modal({
                type: 'primary',
                title: '필수입력',
                text: 'category를 선택 하거나 검색어를 입력해 주십시오.',
            });
            return;
        }

        console.log("PcnctcaeListDataChange-ctcaeVer : " + ctcaeVer);
        console.log("PcnctcaeListDataChange-medDraSoc : " + medDraSoc);

        $.ajax({
            url:'[[@{/aemonitorapi/pcnctcaeList}]]',
            type:'get',
            dataType: 'json',
            data:{
                ctcaeVer : ctcaeVer,
                medDraSoc : medDraSoc,
                searchVal : searchVal,
                [[${_csrf.parameterName}]] : '[[${_csrf.token}]]'
            },
            success:function(data){
                //$("#SymptomDetail").empty();
                tableGrid.clear().draw();

                $.each(data, function(key) {
                    tableGrid.row.add([
                        data[key].term,
                        data[key].medDraCode,
                        data[key].medDraSoc,
                        data[key].ctcaeVer
                    ]).draw(false);
                });
                $("#pcnctcaeTowView").show();
                $("#pcnctcaeGradeView").hide();
                gGrade_Lv = "";

                tableGrid.columns.adjust().draw();
            }
        });
    }

    function copyElement(code) {
        var copyText = $("#" + code).html();
        console.log(copyText);

        var textarea = document.createElement('textarea');
        textarea.textContent = copyText;
        document.body.appendChild(textarea);

        var selection = document.getSelection();
        var range = document.createRange();
        //  range.selectNodeContents(textarea);
        range.selectNode(textarea);
        selection.removeAllRanges();
        selection.addRange(range);
        //document.execCommand('copy')
        if (document.execCommand('copy') == true) {
            modal({
                type: 'success',
                title: 'Success - 클립보드에 복사되었습니다',
                text: copyText
            });
        }
        selection.removeAllRanges();
        document.body.removeChild(textarea);
    }
</script>

<script>
    $('#sdate').datepicker({
        format : "yyyy-mm-dd",
        language : "kr"
    });

    $('#edate').datepicker({
        format : "yyyy-mm-dd",
        language : "kr"
    });
</script>

</th:block>
</body>
</html>
